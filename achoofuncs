#!/bin/bash

# achoofuncs - Various functions called by the main achoo script
# 
# This script and the achoorunning, achooparts and achoodesktop scripts must
# all be present in the same directory as the main achoo script when running.
# 
# Developed by Elizabeth Mills, incorporating some code adapted from
# the Evo/Lution script by Carl Duff and the AUI scripts by HelmuthDU.
# 
# Please read the introduction in the main Achoo! script
# 

# -------------------------
# Functions           Line
# -------------------------
# Input and output     29
# Error-checking       135
# Internet connection  170
# Mirrorlist           222
# Set scope            278
# -------------------------

MeNu() {
# MeNu is an alternative to the bash 'select' function. It generates a
# numbered menu in the centre of the screen. It can receive
# up to 3 parameters:
# 1) a variable array of the items to be listed,
# 2) the prompt, and
# 3) an optional one-word menu heading (which will be underlined).
# Example: MeNu "$Accessories" "Please choose one: " "Accessories"
# The variable array may be declared as follows:
# name="list1 list2 list3 ... " (MeNu includes a 'Done' option)
# Example: Accessories="Conky_Manager Geany Nautilus Terminator Done"
# Or it may be generated by a bash command, eg: Partitionlist=$(lsblk -l | grep 'part')
#
# MeNu sets 2 global variables for use by the calling function ...
# 1) $Response - the item number selected by the user, and
# 2) $Result - the label (from the variable array) of the item selected.
#
# MeNu uses 2 functions:
# 1) print_info (which centres text on the screen), and
# 2) print_list (which aligns subsequent items under the first)
# Those functions must be available to the script

local Complete=0
print_info $3
Underscore=`echo $3 | sed 's/./-/g'`
print_info $Underscore
while [ $Complete -eq 0 ]
do
  local Counter=0
  MenuList=$1
  MenuPrompt="$2"
  for i in $1
  do
    Counter=$((Counter+1))
    if [ $Counter -eq 1 ]; then
      print_info "$Counter) $i"
    else
      print_list "$Counter) $i"
    fi
    ConvertToArray[$Counter]=$i
  done
  Counter=$((Counter+1))
  print_list "$Counter) Done"
  echo
  TPread "$2"
  if [ -z ${Response} ]; then
    invalid_option
  elif [ ${Response} -gt ${Counter} ]; then
    invalid_option
  else
    Result=${ConvertToArray[${Response}]}
    Complete=1
  fi
  print_heading
done
}

contains_element() { # (from AUI scripts)
# check if an element exists in a string
    for e in "${@:2}"; do [[ $e == $1 ]] && break; done;
}

invalid_option() { # (from AUI scripts)
    echo 
    read_timed "Invalid option. Try again ..." 1
}

print_heading() {
  clear
  T_COLS=`tput cols`
  tput cup 1 $((($T_COLS/2)-20))
  printf "~ Achoo! The Arch Linux Installation Script ~\n"
  printf "%$(tput cols)s\n"|tr ' ' '-'
}

print_line() { # from AUI scripts
    printf "%$(tput cols)s\n"|tr ' ' '-'
}

print_info() { # Aligned text according to screen size
  T_COLS=`tput cols`
  if [ $2 ]; then # Second parameter is number of characters to left of centre
    lov=$2
  else
    lov=${#1}
  fi
  if [ ${lov} -lt ${T_COLS} ]; then
    stpt=$(( ($T_COLS - $lov) / 2 ))
    EMPTY="$(printf '%*s' $stpt)"
    echo "$EMPTY $1"
  else
    echo "$1"
  fi
}

print_list() { # Subsequent item(s) in an aligned list (menu)
    if [ $2 ]; then
      lov=$2
      stpt=$(( ($T_COLS - $lov) / 2 ))
      EMPTY="$(printf '%*s' $stpt)"
    fi
   echo "$EMPTY $1"
}

TPecho() { # For displaying status while running on auto
  echo
  CurrentTime=$(date +%s)
  Difference=$(( $CurrentTime-$StartTime ))
  DIFFMIN=$(( $Difference/60 ))
  DIFFSEC=$(( $Difference % 60 ))
  T_COLS=`tput cols`
  tput bold
  lov=${#1}
  if [ ${lov} -lt ${T_COLS} ]; then
    stpt=$(( ($T_COLS - $lov) / 3 ))
    EMPTY="$(printf '%*s' $stpt)"
    echo -e "$EMPTY ${DIFFMIN}m ${DIFFSEC}s - $1 \n"
  else
    echo -e "${DIFFMIN}m ${DIFFSEC}s - $1 \n"
  fi
  tput sgr0
  echo
}

TPread() { # Aligned prompt for user-entry - returns result through $Response
  T_COLS=`tput cols`
  lov=${#1}
  if [ ${lov} -lt ${T_COLS} ]; then
    stpt=$(( ($T_COLS - $lov) / 2 ))
  elif [ ${lov} -gt ${T_COLS} ]; then
    stpt=0
  else
    stpt=$(( ($T_COLS - 10) / 2 ))
  fi
  EMPTY="$(printf '%*s' $stpt)"
  read -p "$EMPTY $1" Response
}

read_timed() { # Now can receive second parameter to set duration
  T_COLS=`tput cols`
  lov=${#1}
  if [ $2 ]; then
    tim=$2
  else
    tim=2
  fi
  if [ ${lov} -lt ${T_COLS} ]; then
    stpt=$(( ($T_COLS - $lov) / 2 ))
    EMPTY="$(printf '%*s' $stpt)"
  else
    EMPTY=""
  fi
  read -t ${tim} -p "$EMPTY $1"
  echo
}

SetPS3() { # Aligned prompt for 'select' command
  T_COLS=`tput cols`
  lov=40
  stpt=$(( ($T_COLS - $lov) / 2 ))
  EMPTY="$(printf '%*s' $stpt)"
  PS3="${EMPTY} Enter the number of your selection : "
}

CheckForError() {
# Check for stderr, display it, then exit script
# Now receiving $2 to flag critical or non-critical error
	if [[ $? -gt 0 ]]; then
    print_heading
    echo
    tput bold
		print_info "Error reported at Line: $1"
    echo
    cat error.log
    echo
    case $2 in
      0) read_timed "The error is not critical, and you may ignore it"
      ;;
      1) print_info "You may ignore the error if you choose, and continue with"
      print_info "the installation, but this may have unexpected consequences."
      TPread "Continue with installation? (y/N): "
      case $Response in
        "n" | "N" | "") tput sgr0
          exit
        ;;
        *) echo ""
      esac
      ;;
      *) print_info "The error is critical, and the script cannot continue"
        "Please press any key: "
        read -n1
        tput sgr0
        exit
    esac
    print_info "Continuing as though nothing has happened"
    tput sgr0
  fi
}

CheckInternet() {
print_heading
print_info "Welcome to the Achoo! Arch Linux installation script."
Retry="Y"
Response=3
while [ $Retry = "Y" ]
do
  print_info "A working internet connection is needed for installation."
  print_info "Please choose which of the following apply: "
  echo
  print_info "1) My computer has a wired connection by ethernet cable;"
  print_list "2) My computer has wifi;"
  print_list "3) I am not connected to the internet;"
  echo
  TPread "Enter the number of your selection : "
  echo
  case $Response in
    1) print_info "Checking your connection now ..."
      CheckConnection
    ;;
    2) print_info "Checking your connection now ..."
      wifi-menu
      CheckConnection
    ;;
    3) read_timed "Sorry, installation cannot continue without an internet connection."
      exit
    ;;
    *) invalid_option
  esac
  print_heading
done
}

CheckConnection() {
while [ $Retry = "Y" ]
do
  if [[ ! $(ping -c 3 google.com) ]]; then
    print_info "Unable to establish a connection. Ensure that your computer"
    print_info "is able to access the internet."
    TPread "Try again? (y/n): "
    Retry=$Response
    if [ $Retry != "Y" ] && [ $Retry != "y" ]; then
      $?=1    # Unable to continue without internet
      CheckForError "${LINENO} 'No internet'" 2
    else
      Retry="Y"
    fi
  else
    Retry="N"
  fi
done
}

ReflectorMirrorList() {
 # Use reflector to generate fast mirror list
  TPecho "Using Reflector to generate mirrorlist"
 # cp -vf /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.orig 2> error.log
 # CheckForError "${LINENO} 'Making safe copy of original mirror-list'" 2
 # pacman -Sy --noconfirm -q reflector 2> error.log
 # CheckForError "${LINENO} 'Installing Reflector'" 2
  reflector --verbose -l 5 --sort rate --save /etc/pacman.d/mirrorlist 2> error.log
  if [[ $? -gt 0 ]]; then
    LocalMirrorList
  else
    chmod +r /etc/pacman.d/mirrorlist 2> error.log
    CheckForError "${LINENO} 'Sharing mirrorlist'" 2
  fi
}

LocalMirrorList() {
# In case Reflector fails, generate and save a shortened mirrorlist of only 
# the mirrors defined in the CountryCode variable. Adapted from Lution AIS
	TPecho "Reflector failed - generating local mirrorlist instead"
	URL="https://www.archlinux.org/mirrorlist/?country=${CountryCode}&use_mirror_status=on"
	MirrorTemp=$(mktemp --suffix=-mirrorlist) 2> error.log
	CheckForError "${LINENO}"
	# Use curl to get list of mirrors from the Arch mirrorlist ${URL} to ${MirrorTemp}
	curl -so ${MirrorTemp} ${URL} 2> error.log
	CheckForError "${LINENO}" 2
	# Use sed to filter entries
	sed -i 's/^#Server/Server/g' ${MirrorTemp} 2> error.log
	CheckForError "${LINENO}" 2
	# Make a safe copy of existing mirrorlist
	mv -f /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.orig 2> error.log
	CheckForError "${LINENO}" 2
	# Replace existing mirrorlist with new local mirrorlist
	mv -f ${MirrorTemp} /etc/pacman.d/mirrorlist 2> error.log
	CheckForError "${LINENO} 'saving mirrorlist'" 2
	chmod +r /etc/pacman.d/mirrorlist 2> error.log
	CheckForError "${LINENO} 'saving mirrorlist'" 2
}

SetScope() {
  Retry="Y"
  Response=1
  while [ $Retry = "Y" ]
  do
    print_heading
    print_info "You can choose to have just a basic Arch Linux installation, "
    print_info "or Achoo can include a desktop environment, set up users, and"
    print_info "automatically install codecs, wifi tools, graphics and other "
    print_info "luxuries for you, including Yaourt. Or you can have all the above"
    print_info "and also choose from a list of extras, such as Firefox, GIMP"
    print_info "LibreOffice, Gparted, Thunderbird, Transmission, etc."
    echo
    print_info "1) Just a basic Arch installation;"
    print_list "2) Arch plus DE, codecs, user setup, etc;"
    print_list "3) As above, plus choice of extras;"
    echo
    TPread "Enter the number of your selection : "
    echo
    case $Response in
      1) Scope="Basic"
        Retry="N"
      ;;
      2) Scope="Full"
        Retry="N"
      ;;
      3) Scope="Extras"
        Retry="N"
      ;;
      *) invalid_option
    esac
  done
}

